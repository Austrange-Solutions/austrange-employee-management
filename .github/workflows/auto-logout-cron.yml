name: Auto Logout Employees

# Run daily at 11:59 PM IST (6:29 PM UTC)
# IST is UTC+5:30, so 11:59 PM IST = 6:29 PM UTC (23:59 - 5:30 = 18:29)
on:
  schedule:
    # Cron format: minute hour day month day-of-week (all in UTC)
    # 29 18 * * * means 6:00 PM UTC daily = 11:59 PM IST
    - cron: "0 18 * * *"

  # Allow manual workflow dispatch for testing
  workflow_dispatch:
    inputs:
      reason:
        description: "Reason for manual trigger"
        required: false
        default: "Manual test"

jobs:
  auto-logout:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Display execution time
        run: |
          echo "ðŸ•› Auto-logout workflow triggered"
          echo "ðŸ“… UTC Time: $(date -u)"
          echo "ðŸ“… IST Time: $(TZ=Asia/Kolkata date)"
          echo "ðŸ”§ Manual trigger reason: ${{ github.event.inputs.reason || 'Scheduled run' }}"

      - name: Call auto-logout API endpoint
        env:
          SITE_URL: ${{ secrets.SITE_URL }}
        run: |
          echo "ðŸŒ Calling auto-logout API at: $SITE_URL/api/cron/auto-logout"

          # Make POST request to the auto-logout endpoint
          response=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Content-Type: application/json" \
            "$SITE_URL/api/cron/auto-logout")

          # Extract HTTP status code (last line)
          http_code=$(echo "$response" | tail -n 1)

          # Extract response body (all lines except last)
          response_body=$(echo "$response" | sed '$d')

          echo "ðŸ“Š Response Status: $http_code"
          echo "ðŸ“¦ Response Body:"
          echo "$response_body" | jq '.' || echo "$response_body"

          # Check if the request was successful (2xx status code)
          if [ "$http_code" -ge 200 ] && [ "$http_code" -lt 300 ]; then
            echo "âœ… Auto-logout completed successfully!"
            exit 0
          elif [ "$http_code" -eq 207 ]; then
            echo "âš ï¸  Auto-logout completed with some errors (Multi-Status)"
            exit 0
          else
            echo "âŒ Auto-logout failed with status code: $http_code"
            exit 1
          fi

      - name: Send notification on failure
        if: failure()
        run: |
          echo "âŒ Auto-logout workflow failed!"
          echo "Please check the logs and ensure the SITE_URL secret is correctly configured."
          echo "Manual intervention may be required."

      - name: Workflow summary
        if: always()
        run: |
          echo "## Auto-Logout Summary ðŸ“Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered By**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **UTC Time**: $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "- **IST Time**: $(TZ=Asia/Kolkata date)" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "- **Manual Trigger Reason**: ${{ github.event.inputs.reason }}" >> $GITHUB_STEP_SUMMARY
          fi
